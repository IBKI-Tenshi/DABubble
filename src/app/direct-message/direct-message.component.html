<div class="direct-message-container">
  <!-- Header mit Chatpartner -->
  <div class="dm-header">
    <div class="user-info">
      <img
        [src]="partnerAvatarUrl"
        alt="Avatar"
        class="user-avatar"
        (click)="openProfileView(partnerName, partnerAvatarUrl)"
      />
      <span class="user-name">{{ partnerName }}</span>
    </div>
  </div>

  <!-- Messages Area -->
  <div class="chat-content">
    <!-- Empty State -->
    <ng-container *ngIf="messages.length === 0">
      <div class="user-profile">
        <img [src]="partnerAvatarUrl" class="profile-avatar" alt="{{ partnerName }}" />
        <h2 class="profile-name">{{ partnerName }}</h2>
        <div class="chat-privacy-info">
          Diese Unterhaltung findet nur zwischen
          <span class="mention">{{ '@' + partnerName }}</span> und dir statt.
        </div>
      </div>

      <!-- Input bei leerem Verlauf -->
      <div class="message-input-container">
        <input
          type="text"
          class="message-input"
          [(ngModel)]="newMessageText"
          placeholder="Nachricht an {{ partnerName }}"
          (keydown)="onKeyDown($event)"
        />
        <div class="input-actions">
          <button class="emoji-btn" type="button" (click)="toggleEmojiPickerForInput()">
            <mat-icon>sentiment_satisfied_alt</mat-icon>
          </button>
          <button class="mention-btn" type="button">
            <mat-icon>alternate_email</mat-icon>
          </button>
        </div>
        <button
          class="send-btn"
          type="button"
          [disabled]="!newMessageText.trim()"
          (click)="sendMessage()"
        >
          <mat-icon>send</mat-icon>
        </button>
      </div>
    </ng-container>

    <!-- Nachrichtenliste -->
    <ng-container *ngIf="messages.length > 0">
      <div class="messages-container" #messagesContainer>
        <ng-container *ngFor="let group of groupedMessages">
          <!-- Datum -->
          <div class="date-separator">
            <div class="line"></div>
            <div class="date-pill">{{ group.dateLabel }}</div>
            <div class="line"></div>
          </div>

          <!-- Nachrichten des Datums -->
          <div
            *ngFor="let message of group.messages"
            class="message-item"
            [class.outgoing-message]="message.senderId === senderName"
            (mouseover)="onMessageHover(message.id!)"
            (mouseleave)="onMessageLeave()"
          >
            <!-- Hover-Tools -->
            <app-reaction-tools
              *ngIf="hoveredMessageId === message.id"
              [isOwn]="isOwnMessage(message)"
              [messageId]="message.id!"
              [messageText]="message.text"
              (onEdit)="startEditing(message.id!, message.text)"
              (onReaction)="addReaction(message.id!, $event)"
              (onDm)="goToDM(message.senderId)"
            >
            </app-reaction-tools>

            <!-- Avatar -->
            <div class="message-avatar">
              <img
                [src]="message.avatar || getAvatarForUser(message.senderId)"
                alt="Avatar"
                class="avatar-img"
                (click)="openProfileView(message.senderId, getAvatarForUser(message.senderId))"
              />
            </div>

            <!-- Inhalt -->
            <div class="message-content">
              <div class="message-header">
                <span
                  class="sender-name"
                  (click)="openProfileView(message.senderId, message.avatar || (message.senderId === senderName ? senderAvatar : partnerAvatarUrl))"
                >
                  {{ message.senderId }}
                </span>
                <span class="timestamp">{{ message.timestamp | date : 'HH:mm' }} Uhr</span>
              </div>

              <!-- Normal -->
              <ng-container *ngIf="message.id !== editingMessageId">
                <div class="message-text">{{ message.text }}</div>
              </ng-container>

              <!-- Edit -->
              <ng-container *ngIf="message.id === editingMessageId">
                <div class="edit-container">
                  <textarea
                    class="edit-input"
                    [(ngModel)]="editingMessageText"
                    placeholder="Nachricht bearbeiten..."
                  ></textarea>

                  <div class="edit-actions">
                    <button
                      class="edit-emoji-button"
                      (click)="toggleEmojiPickerForMessage(message.id!)"
                    >
                      <mat-icon>sentiment_satisfied_alt</mat-icon>
                    </button>

                    <div class="edit-buttons">
                      <button class="cancel-button" (click)="cancelEditing()">Abbrechen</button>
                      <button class="save-button" (click)="saveEditedMessage(message.id!)">
                        Speichern
                      </button>
                    </div>
                  </div>

                  <!-- Emoji Picker beim Edit (korrekt an showEmojiPickerForMessage gebunden) -->
                  <div
                    *ngIf="showEmojiPickerForMessage === message.id"
                    class="emoji-picker-container emoji-picker-for-message"
                    (click)="$event.stopPropagation()"
                  >
                    <emoji-mart
                      [style]="{ width: '320px', height: '320px', padding: '0' }"
                      [i18n]="{
                        search: 'Suchen',
                        categories: {
                          people: 'Smileys',
                          nature: 'Natur',
                          foods: 'Essen',
                          activity: 'Aktivitäten',
                          objects: 'Objekte',
                          symbols: 'Symbole'
                        },
                        notfound: 'Keine Emojis gefunden',
                        searchResults: 'Suchergebnisse'
                      }"
                      title="Emoji auswählen"
                      [darkMode]="false"
                      [set]="'apple'"
                      [include]="emojiCategories"
                      [showPreview]="false"
                      [emojiSize]="20"
                      [perLine]="8"
                      [recent]="[]"
                      [enableFrequentEmojiSort]="false"
                      [autoFocus]="false"
                      [custom]="[]"
                      (emojiClick)="addEmojiToMessage($event)"
                    >
                    </emoji-mart>
                  </div>
                </div>
              </ng-container>

              <!-- Reactions (nur wenn vorhanden) -->
              <div
                *ngIf="message.reactions && message.reactions.length > 0"
                class="reactions"
                [attr.data-mid]="message.id"
              >
                <!-- sichtbare Reaktionen -->
                <app-reaction-bubble
                  *ngFor="let reaction of getVisibleReactions(message)"
                  [reaction]="reaction"
                  [currentUser]="senderName"
                  (reactionClick)="addReaction(message.id!, {emoji: {native: $event.emoji}})"
                >
                </app-reaction-bubble>

                <!-- +X weitere -->
                <div
                  *ngIf="getHiddenReactionsCount(message) > 0"
                  class="reaction-bubble more-reactions"
                  (click)="toggleReactionsExpansion(message.id!)"
                >
                  <span>+{{ getHiddenReactionsCount(message) }} weitere</span>
                </div>

                <!-- Weniger anzeigen -->
                <div
                  *ngIf="
                    expandedReactions[message.id!] &&
                    message.reactions.length >
                      (isMobile ? MAX_MOBILE_REACTIONS : MAX_DESKTOP_REACTIONS)
                  "
                  class="reaction-bubble show-less"
                  (click)="toggleReactionsExpansion(message.id!)"
                >
                  <span>Weniger anzeigen</span>
                </div>

                <!-- + Button -->
                <div
                  class="reaction-bubble add-reaction-button"
                  #addBtn
                  (click)="toggleReactionPicker(message.id!, addBtn, $event)"
                ></div>

                <!-- Emoji Picker (Overlay/fixed, an den Button geankert) -->
                <div
                  *ngIf="showEmojiPickerForReaction === message.id"
                  class="emoji-picker-container emoji-picker-for-reaction"
                  [style.position]="'fixed'"
                  [style.left.px]="reactionPickerPos[message.id].left"
                  [style.top.px]="reactionPickerPos[message.id].top"
                  (click)="$event.stopPropagation()"
                >
                  <emoji-mart
                    [style]="{ width: '320px', height: '320px', padding: '0' }"
                    [i18n]="{
                      search: 'Suchen',
                      categories: {
                        people: 'Smileys',
                        nature: 'Natur',
                        foods: 'Essen',
                        activity: 'Aktivitäten',
                        objects: 'Objekte',
                        symbols: 'Symbole'
                      },
                      notfound: 'Keine Emojis gefunden',
                      searchResults: 'Suchergebnisse'
                    }"
                    title="Emoji auswählen"
                    [darkMode]="false"
                    [set]="'apple'"
                    [include]="emojiCategories"
                    [showPreview]="false"
                    [emojiSize]="20"
                    [perLine]="8"
                    [recent]="[]"
                    [enableFrequentEmojiSort]="false"
                    [autoFocus]="false"
                    [custom]="[]"
                    (emojiClick)="addReaction(message.id!, $event)"
                  >
                  </emoji-mart>
                </div>
              </div>
              <!-- Keine Reactions: nichts rendern (Add via Hover-Tools) -->
            </div>
          </div>
        </ng-container>
      </div>

      <!-- Input Area -->
      <div class="message-input-container">
        <input
          type="text"
          class="message-input"
          [(ngModel)]="newMessageText"
          placeholder="Nachricht an {{ partnerName }}"
          (keydown)="onKeyDown($event)"
        />
        <div class="input-actions">
          <button class="emoji-btn" type="button" (click)="toggleEmojiPickerForInput()">
            <mat-icon>sentiment_satisfied_alt</mat-icon>
          </button>
          <button class="mention-btn" type="button">
            <mat-icon>alternate_email</mat-icon>
          </button>
        </div>
        <button
          class="send-btn"
          type="button"
          [disabled]="!newMessageText.trim()"
          (click)="sendMessage()"
        >
          <mat-icon>send</mat-icon>
        </button>
      </div>
    </ng-container>

    <!-- Emoji Picker für Eingabefeld -->
    <div
      *ngIf="showEmojiPickerForInput"
      class="emoji-picker-container emoji-picker-for-input"
      #emojiPicker
      (click)="$event.stopPropagation()"
    >
      <emoji-mart
        [style]="{ width: '320px', height: '320px', padding: '0' }"
        [i18n]="{
          search: 'Suchen',
          categories: {
            people: 'Smileys',
            nature: 'Natur',
            foods: 'Essen',
            activity: 'Aktivitäten',
            objects: 'Objekte',
            symbols: 'Symbole'
          },
          notfound: 'Keine Emojis gefunden',
          searchResults: 'Suchergebnisse'
        }"
        title="Emoji auswählen"
        [darkMode]="false"
        [set]="'apple'"
        [include]="emojiCategories"
        [showPreview]="false"
        [emojiSize]="20"
        [perLine]="8"
        [recent]="[]"
        [enableFrequentEmojiSort]="false"
        [autoFocus]="false"
        [custom]="[]"
        (emojiClick)="addEmojiToInput($event)"
      >
      </emoji-mart>
    </div>
  </div>
</div>
